#!/bin/bash

# SSH密钥自动配置脚本 - 增强版

# 支持自动化配置和错误处理

# 颜色定义

RED=’\033[0;31m’
GREEN=’\033[0;32m’
YELLOW=’\033[1;33m’
BLUE=’\033[0;34m’
CYAN=’\033[0;36m’
NC=’\033[0m’ # No Color

# 显示标题

show_title() {
clear
echo -e “${BLUE}╔══════════════════════════════════════════════════════════╗${NC}”
echo -e “${BLUE}║${CYAN}          SSH密钥自动配置工具 - 增强版              ${BLUE}║${NC}”
echo -e “${BLUE}╚══════════════════════════════════════════════════════════╝${NC}\n”
}

# 日志函数

log_success() {
echo -e “${GREEN}✓ $1${NC}”
}

log_error() {
echo -e “${RED}✗ $1${NC}”
}

log_info() {
echo -e “${CYAN}ℹ $1${NC}”
}

log_warning() {
echo -e “${YELLOW}⚠ $1${NC}”
}

# 错误退出

error_exit() {
log_error “$1”
exit 1
}

# 检查必要工具

check_requirements() {
log_info “检查必要工具…”

```
for cmd in ssh ssh-keygen ssh-copy-id; do
    if ! command -v $cmd &> /dev/null; then
        log_error "缺少必要工具: $cmd"
        echo -e "${YELLOW}尝试安装...${NC}"
        
        if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y openssh-client
        elif command -v yum &> /dev/null; then
            sudo yum install -y openssh-clients
        else
            error_exit "无法自动安装SSH工具，请手动安装"
        fi
    fi
done

log_success "所有必要工具已就绪\n"
```

}

# 验证IP地址格式

validate_ip() {
local ip=$1
if [[ $ip =~ ^[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}$ ]]; then
return 0
else
return 1
fi
}

# 验证端口号

validate_port() {
local port=$1
if [[ $port =~ ^[0-9]+$ ]] && [ $port -ge 1 ] && [ $port -le 65535 ]; then
return 0
else
return 1
fi
}

# 收集配置信息

collect_config() {
echo -e “${YELLOW}请输入SSH连接信息:${NC}\n”

```
# 读取用户名
read -p "请输入远程服务器用户名: " username
while [ -z "$username" ]; do
    log_error "用户名不能为空"
    read -p "请输入远程服务器用户名: " username
done

# 读取IP地址
read -p "请输入服务器IP地址: " ip_address
while [ -z "$ip_address" ] || ! validate_ip "$ip_address"; do
    log_error "请输入有效的IP地址（例如: 192.168.1.100）"
    read -p "请输入服务器IP地址: " ip_address
done

# 读取端口
read -p "请输入SSH端口 [默认: 22]: " port
port=${port:-22}
while ! validate_port "$port"; do
    log_error "请输入有效的端口号（1-65535）"
    read -p "请输入SSH端口 [默认: 22]: " port
    port=${port:-22}
done

# 显示配置预览
echo -e "\n${CYAN}配置预览:${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "用户名: ${GREEN}$username${NC}"
echo -e "IP地址: ${GREEN}$ip_address${NC}"
echo -e "端口: ${GREEN}$port${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"

read -p "确认配置并继续? [Y/n]: " confirm
if [[ "$confirm" =~ ^[Nn]$ ]]; then
    log_warning "配置已取消"
    exit 0
fi
```

}

# 检查现有密钥

check_existing_key() {
log_info “检查现有SSH密钥…”

```
if [ -f ~/.ssh/id_rsa ]; then
    echo -e "\n${YELLOW}检测到现有SSH密钥:${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    ssh-keygen -lf ~/.ssh/id_rsa.pub 2>/dev/null
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
    
    read -p "是否使用现有密钥? (选择'n'将生成新密钥) [Y/n]: " use_existing
    
    if [[ "$use_existing" =~ ^[Nn]$ ]]; then
        read -p "⚠️  生成新密钥将覆盖现有密钥，确定继续? [y/N]: " confirm_overwrite
        if [[ "$confirm_overwrite" =~ ^[Yy]$ ]]; then
            generate_new_key
        else
            log_info "继续使用现有密钥"
        fi
    else
        log_success "使用现有密钥"
    fi
else
    generate_new_key
fi
```

}

# 生成新密钥

generate_new_key() {
log_info “生成新的SSH密钥…”

```
# 备份旧密钥（如果存在）
if [ -f ~/.ssh/id_rsa ]; then
    backup_dir=~/.ssh/backup_$(date +%Y%m%d_%H%M%S)
    mkdir -p "$backup_dir"
    mv ~/.ssh/id_rsa* "$backup_dir/" 2>/dev/null
    log_warning "旧密钥已备份到: $backup_dir"
fi

# 生成新密钥
ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa -q -C "$(whoami)@$(hostname)-$(date +%Y%m%d)"

if [ $? -eq 0 ]; then
    log_success "SSH密钥生成成功\n"
    echo -e "${CYAN}公钥指纹:${NC}"
    ssh-keygen -lf ~/.ssh/id_rsa.pub
    echo ""
else
    error_exit "SSH密钥生成失败"
fi
```

}

# 测试SSH连接

test_connection() {
log_info “测试SSH连接（需要输入密码）…”

```
# 尝试连接
ssh -p "$port" -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$username@$ip_address" "echo '连接测试成功'" 2>/tmp/ssh_test_error.log

if [ $? -eq 0 ]; then
    log_success "SSH连接测试成功\n"
    return 0
else
    log_error "SSH连接测试失败"
    
    if [ -f /tmp/ssh_test_error.log ]; then
        echo -e "${RED}错误信息:${NC}"
        cat /tmp/ssh_test_error.log
    fi
    
    echo -e "\n${YELLOW}可能的原因:${NC}"
    echo "1. IP地址或端口不正确"
    echo "2. SSH服务未运行"
    echo "3. 防火墙阻止连接"
    echo "4. 用户名或密码错误"
    
    read -p "是否继续尝试配置密钥? [y/N]: " continue_anyway
    if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
        exit 1
    fi
    return 1
fi
```

}

# 复制公钥到远程服务器

copy_public_key() {
echo -e “\n${YELLOW}正在复制公钥到远程服务器…${NC}”
log_info “请输入远程服务器密码（这是最后一次需要输入密码）\n”

```
# 使用ssh-copy-id命令
ssh-copy-id -p "$port" -o StrictHostKeyChecking=no "$username@$ip_address" 2>/tmp/ssh_copy_error.log

if [ $? -eq 0 ]; then
    log_success "公钥复制成功\n"
    return 0
else
    log_error "公钥复制失败"
    
    if [ -f /tmp/ssh_copy_error.log ]; then
        echo -e "${RED}错误信息:${NC}"
        cat /tmp/ssh_copy_error.log
        echo ""
    fi
    
    # 提供手动方案
    echo -e "${YELLOW}您可以手动添加公钥:${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    cat ~/.ssh/id_rsa.pub
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "\n${YELLOW}手动添加步骤:${NC}"
    echo "1. 登录远程服务器"
    echo "2. 编辑 ~/.ssh/authorized_keys 文件"
    echo "3. 将上面的公钥粘贴到文件末尾"
    echo "4. 保存并设置权限: chmod 600 ~/.ssh/authorized_keys"
    
    return 1
fi
```

}

# 验证无密码登录

verify_passwordless_login() {
log_info “验证无密码登录…”

```
ssh -p "$port" -o BatchMode=yes -o ConnectTimeout=10 "$username@$ip_address" "echo '无密码登录验证成功'" 2>/tmp/verify_error.log

if [ $? -eq 0 ]; then
    log_success "无密码登录配置成功！\n"
    return 0
else
    log_error "无密码登录验证失败"
    
    if [ -f /tmp/verify_error.log ]; then
        echo -e "${RED}错误信息:${NC}"
        cat /tmp/verify_error.log
    fi
    
    return 1
fi
```

}

# 创建快捷连接脚本

create_connection_script() {
local script_name=“ssh-connect-${username}@${ip_address}.sh”

```
cat > ~/"$script_name" << EOF
```

#!/bin/bash

# SSH快捷连接脚本

# 目标: $username@$ip_address:$port

# 创建时间: $(date ‘+%F %T’)

ssh -p $port $username@$ip_address “$@”
EOF

```
chmod +x ~/"$script_name"
log_success "快捷连接脚本已创建: ~/$script_name\n"
```

}

# 创建SSH配置条目

create_ssh_config() {
local config_file=~/.ssh/config
local host_alias=“server_${ip_address//./_}”

```
# 确保config文件存在
touch "$config_file"
chmod 600 "$config_file"

# 检查是否已存在该主机配置
if grep -q "Host $host_alias" "$config_file"; then
    log_warning "SSH配置已存在，跳过创建"
    return
fi

# 添加配置
cat >> "$config_file" << EOF
```

# 添加于 $(date ‘+%F %T’)

Host $host_alias
HostName $ip_address
User $username
Port $port
IdentityFile ~/.ssh/id_rsa
ServerAliveInterval 60
ServerAliveCountMax 3
EOF

```
log_success "SSH配置已添加到 ~/.ssh/config"
log_info "使用别名连接: ${GREEN}ssh $host_alias${NC}\n"
```

}

# 显示使用说明

show_usage() {
echo -e “${BLUE}╔══════════════════════════════════════════════════════════╗${NC}”
echo -e “${BLUE}║${GREEN}                   配置成功完成！                      ${BLUE}║${NC}”
echo -e “${BLUE}╚══════════════════════════════════════════════════════════╝${NC}\n”

```
echo -e "${CYAN}连接方式:${NC}"
echo -e "1. 标准命令: ${GREEN}ssh -p $port $username@$ip_address${NC}"
echo -e "2. 使用别名: ${GREEN}ssh server_${ip_address//./_}${NC}"
echo -e "3. 快捷脚本: ${GREEN}~/ssh-connect-${username}@${ip_address}.sh${NC}\n"

echo -e "${CYAN}其他操作:${NC}"
echo -e "- 复制文件: ${GREEN}scp -P $port file.txt $username@$ip_address:~/path/${NC}"
echo -e "- 同步目录: ${GREEN}rsync -avz -e 'ssh -p $port' dir/ $username@$ip_address:~/path/${NC}\n"

echo -e "${YELLOW}配置文件位置:${NC}"
echo -e "- 私钥: ~/.ssh/id_rsa"
echo -e "- 公钥: ~/.ssh/id_rsa.pub"
echo -e "- SSH配置: ~/.ssh/config\n"
```

}

# 主流程

main() {
show_title

```
# 检查工具
check_requirements

# 收集配置
collect_config

# 检查密钥
check_existing_key

# 测试连接
test_connection

# 复制公钥
if copy_public_key; then
    # 验证登录
    if verify_passwordless_login; then
        # 创建辅助脚本
        create_connection_script
        create_ssh_config
        
        # 显示使用说明
        show_usage
    else
        log_warning "虽然公钥已复制，但无密码登录验证失败"
        echo -e "${YELLOW}请检查远程服务器的SSH配置${NC}"
    fi
else
    log_error "SSH密钥配置未完成"
    exit 1
fi
```

}

# 运行主程序

main
